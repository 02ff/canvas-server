

<% if !@is_mobile %>
<!-- Products section -->
<div class="section">
    
  <div class="container">
    <div class="row">
      <!-- Products -->
      <div class="col-12 col-lg-9 order-lg-2">
        <div class="row align-items-center">
          <div class="col-7 text-left">
            <%= link_to new_painting_path do %>
              <button type="button" class="btn btn-outline-dark">작품 등록하기</button>
            <% end %>
          </div>
          <div class="col-5 text-right">
            <form id="painting-search" action="<%= painting_search_path %>">
              <div class="input-group">
                <input type="hidden" id="search_category" name="search_category" value="title">
                <input type="text" id="search_query" name="search_query" class="form-control" aria-label="Text input with segmented dropdown button">
                <div class="input-group-append">
                  <button type="submit" class="btn btn-outline-dark no-border-radius">검색</button>
                  <button type="button" class="btn btn-outline-dark no-border-radius dropdown-toggle dropdown-toggle-split" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    <span class="sr-only">Toggle Dropdown</span>
                  </button>
                  <div class="dropdown-menu">
                    <a onclick="searchCategoryClicked(this)" data-category="artist" class="dropdown-item" href="#">작가명</a>
                    <a onclick="searchCategoryClicked(this)" data-category="title" class="dropdown-item" href="#">작품명</a>
                  </div>
                </div>
              </div>
              <span id="search-category-label">작품명</span>
            </form>
            <!-- <select id="filter-select" onchange="filterChanged(this)" class="custom-select">
              <option value="0" selected>최신순</option>
              <option value="1">좋아요 순</option>
              <option value="2">낮은 가격 순</option>
              <option value="3">높은 가격 순</option>
              <option value="4">Sort by Price: low to high</option>
            </select> -->
          </div>
        </div>

        
        
        <div id="paintings-container" class="row product-wrapper product-hover-style-2 margin-top-50">
          
          <% @paintings.each do |painting| %>
            <%= render 'painting', painting: painting %>
          <% end %>
          
          <div id="infinite-scrolling" style="display: none;">
            <%= will_paginate @paintings %>
          </div>

        </div>
        
        <!-- Pagination -->
        <!-- <nav>
          <ul class="pagination justify-content-center margin-top-70">
            <li class="page-item"><a class="page-link" href="#">&laquo;</a></li>
            <li class="page-item active"><a class="page-link" href="#">1</a></li>
            <li class="page-item"><a class="page-link" href="#">2</a></li>
            <li class="page-item"><a class="page-link" href="#">3</a></li>
            <li class="page-item"><a class="page-link" href="#">&raquo;</a></li>
          </ul>
        </nav> -->
      </div>
      
      <!-- Sidebar -->
      <div class="col-12 col-lg-3 order-lg-1 shop-sidebar">
        <!-- Sidebar box 1 - Category -->
        <div class="shop-sidebar-box">
          <h5 class="font-weight-light margin-bottom-20">
            Category
            <ion-icon onclick="filterInit('category')" name="sync" class="float-right"></ion-icon>
          </h5>
          <ul class="shop-sidebar-category">
            <% @categories.each do |category| %>
              <li>
                
                <%= link_to "javascript:void(0);", 
                    data: { category: category.id }, 
                    onclick: "filterByCategory(event)",
                    class: "category-option option" do %>
                  <%= category.name %> 
                  <span><%= category.paintings.count %></span>
                <% end %>
                
              </li>
            <% end %>
          </ul>
        </div>

        <!-- Sidebar box 3 - Size -->
        <div class="shop-sidebar-box">
          <h5 class="font-weight-light margin-bottom-20">
            Price
            <ion-icon onclick="filterInit('price')" name="sync" class="float-right"></ion-icon>
          </h5>
          <ul class="shop-sidebar-size">
            <% @prices.each_with_index do |price, index| %>
              <li>
                <%= link_to "javascript:void(0);",
                data: { price: price.id },
                onclick: "filterByPrice(this)",
                class: "price-option option" do %>
                  <% cheap_price = index!= 0 ? number_to_currency(@prices[index-1].value, unit: '', precision: 0) : 0 %>
                  <%= cheap_price %>원
                  - <%= number_to_currency(price.value, unit: '', precision: 0) %>원
                <% end %>
              </li>
            <% end %>
          </ul>
        </div>

        <!-- Sidebar box 2 - Color -->
        <div class="shop-sidebar-box">
          <h5 class="font-weight-light margin-bottom-20">
            Color
            <ion-icon onclick="filterInit('color')" name="sync" class="float-right"></ion-icon>
          </h5>
          <ul class="shop-sidebar-color">
            <% @colors.each do |color| %>
              <li>
                <%= link_to "javascript:void(0);",
                    data: { color: color.id },
                    onclick: "filterByColor(event)",
                    class: "color-option option" do %>
                  <%= color.name %> 
                  <span style="background: <%= color.hex %>"></span>
                <% end %>
              </li>
            <% end %>
            <!-- You can use (style="background: ..") to set custom colors 
              <li><a href="#">Custom Color <span style="background: #ff7373"></span></a></li> -->
          </ul>
        </div>
        
      </div>
      
    </div><!-- end row -->
  </div><!-- end container -->
</div>
<!-- end Products section -->
<% else %>
<!-- MOBILE MODE -->
<div class="section">
  <div class="container">
    <div class="row">
      
      <!-- Products -->
      <div class="col-12 col-lg-9 order-lg-2">
        <div class="row align-items-center">
          <div class="col-6 text-left">
            <%= link_to new_painting_path do %>
              <button type="button" class="btn btn-outline-dark">작품 등록하기</button>
            <% end %>
          </div>
          <div class="col-6 text-right">
            <!-- <select class="custom-select">
              <option selected>Newest</option>
              <option value="1">Sort by Popularity</option>
              <option value="1">Sort by Rating</option>
              <option value="2">Sort by Price: high to low</option>
              <option value="3">Sort by Price: low to high</option>
            </select> -->

            <!-- Button trigger modal -->
            <button data-toggle="modal" data-target="#mobileFilter" type="button" class="btn btn-outline-dark">필터</button>
            
            <%= render 'filter_mobile' %>

          </div>
          
          
        </div>
        <div class="row margin-top-20">
            
          <div class="col-12">
            <form id="painting-search" action="<%= painting_search_path %>">
              <div class="input-group">
                <input type="hidden" id="search_category" name="search_category" value="title">
                <button type="button" class="btn btn-outline-dark no-border-radius dropdown-toggle dropdown-toggle-split" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                  <span class="sr-only">Toggle Dropdown</span>
                </button>
                <input type="text" id="search_query" name="search_query" class="form-control" aria-label="Text input with segmented dropdown button">
                <div class="input-group-append">
                  <button type="submit" class="btn btn-outline-dark no-border-radius">검색</button>
                  
                  <div class="dropdown-menu">
                    <a onclick="searchCategoryClicked(this)" data-category="artist" class="dropdown-item" href="#">작가명</a>
                    <a onclick="searchCategoryClicked(this)" data-category="title" class="dropdown-item" href="#">작품명</a>
                  </div>
                </div>
                
              </div>
              <span id="search-category-label">작품명</span>
            </form>
          </div>
        </div>
        <div id="paintings-container" class="row product-wrapper product-hover-style-2 margin-top-50">
          <% @paintings.each do |painting| %>
            <%= render 'painting', painting: painting %>
            
          <% end %>
          
          <div id="infinite-scrolling" style="display: none;">
            <%= will_paginate @paintings %>
          </div>

        </div><!-- end row(inner) -->
        <!-- Pagination -->
        <!-- <nav>
          <ul class="pagination justify-content-center margin-top-70">
            <li class="page-item"><a class="page-link" href="#">&laquo;</a></li>
            <li class="page-item active"><a class="page-link" href="#">1</a></li>
            <li class="page-item"><a class="page-link" href="#">2</a></li>
            <li class="page-item"><a class="page-link" href="#">3</a></li>
            <li class="page-item"><a class="page-link" href="#">&raquo;</a></li>
          </ul>
        </nav> -->
      </div>
    </div><!-- end row -->
  </div><!-- end container -->
</div>
<% end %>
<script>
var sentRequest = true;
var isFinished = false;

$(function(){

  setInterval(function(){
    // masonry 가 원활히 적용되지 않던 이슈 일단 이렇게 적용
    $('#paintings-container').masonry({
      // options
      itemSelector : '.item',
    
    });
  })

  activateScroll();

}, 300);

function activateScroll(){
  if($('#infinite-scrolling')[0]){
    // infinite-scroll이 존재하면
    
    $(window).on('scroll', function(){
      let needLoad = $(window).scrollTop() > $(document).height() - $(window).height() - 60;
      loadPaintings(needLoad);
      
    })
  }
}

function loadPaintings(needLoad){
  if(needLoad && sentRequest && !isFinished){
        
    if(document.getElementsByClassName('selected').length == 0){
      makeAjaxLoad(false);
    } else {
      makeAjaxFilter(false);  
    }
    
  }
}

function initLoad(){
  if($('.next_page')[0]){

  } else {
    $('#paintings-container').html(`
    <div id="infinite-scrolling" style="display: none;">
      <%= will_paginate @paintings %>
    </div>`);
  }
  $('.next_page').attr('href', '/paintings?page=1');

  if(document.getElementsByClassName('selected').length == 0){
    makeAjaxLoad(false);

  } else {
    makeAjaxFilter(true);  
  }
}

function filterByCategory(e){
  e.stopPropagation();
  let element = e.target;
  let categoryId = parseInt(element.dataset.category);
  isFinished = false;
  toggleSelected(element, '.category-option');
  
  initLoad();
  
  
}

function filterByPrice(element){
  
  let priceId = parseInt(element.dataset.price);
  isFinished = false;
  var selected = false;
  if(element.classList.contains('selected')){
    selected = true;
  }

  $('.price-option').removeClass('selected');
  
  if(selected){
    
    element.classList.remove('selected');  
  } else {
    
    element.classList.add('selected');
  }

  initLoad();

}

function filterByColor(e){
  e.stopPropagation();
  let element = e.target;
  let colorId = parseInt(element.dataset.color);
  isFinished = false;
  toggleSelected(element, '.color-option');
  initLoad();
}

function toggleSelected(element, className){
  if(element.classList.contains('selected')){
    // $(className).removeClass('selected');
    element.classList.remove('selected');  
  } else {
    // $(className).removeClass('selected');
    element.classList.add('selected');
  }
}

function makeAjaxLoad(needRefresh){
  sentRequest = false;
  let filterType = $('#filter-select').val();
  var morePostUrl = $('.next_page').attr('href');
  
  if(needRefresh){
    morePostUrl += '&refresh=true';
  } else {
    morePostUrl = morePostUrl.replace('&refresh=true', '');
  }

  // ACTIVATE PRELOADER
  $.ajax({
    url: morePostUrl,
    dataType: "script", // important! (js.erb 실행)
    method: "GET",
    success: function(){
      sentRequest = true;
    }
  })
}

function makeAjaxFilter(needRefresh){
  sentRequest = false;
  let filterType = $('#filter-select').val();
  let morePostUrl = $('.next_page').attr('href');
  let selectedArr = document.getElementsByClassName('selected');
  // var queryString = '?';
  var url = '';
  for(var i = 0 ; i < selectedArr.length ; i++){
    var dataset = selectedArr[i].dataset;
    for(var key in dataset){
      morePostUrl += '&' + key + '_id[]=' + dataset[key]
    }
  }
  
  if(needRefresh){
    morePostUrl += '&refresh=true';
  } else {
    morePostUrl = morePostUrl.replace('&refresh=true', '');
  }
  
  $.ajax({
    url: morePostUrl,
    method: 'GET',
    dataType: "script",
    success: function(){
      sentRequest = true;
    }
  })
}

function filterInit(name){
  
  $('#paintings-container').html(`
  <div id="infinite-scrolling" style="display: none;">
    <%= will_paginate @paintings %>
  </div>`);
  isFinished = false;

  $('.' + name + '-option').removeClass('selected');
  initLoad();
  
}
function searchCategoryClicked(element){
  let category = element.dataset.category;
  switch(category){
    case 'artist':
      $('#search-category-label').text('작가명');
      $('#search_category').val('artist');
      break;
    case 'title':
      $('#search_category').val('title');
      $('#search-category-label').text('작품명');
      break;
  }
}
</script>